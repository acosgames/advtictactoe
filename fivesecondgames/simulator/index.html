<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>The HTML5 Herald</title>
        <meta name="description" content="The HTML5 Herald" />
        <meta name="author" content="SitePoint" />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.socket.io/3.1.3/socket.io.min.js"
            integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #wrapper,
            #game-sandbox {
                width: 100%;
                height: 100%;
                border: 0;
                border-spacing: 0;
            }
        </style>
        <div id="wrapper">
            <button id="joingame" type="button" class="btn btn-primary">Join Game</button>
            <button id="reload" type="button" class="btn btn-primary">Reload</button>
            <iframe id="game-sandbox" sandbox="allow-scripts" src="/iframe"> </iframe>
        </div>

        <script>
            const socket = io('ws://localhost:3000', { transports: ['websocket'], upgrade: true });

            socket.on('game', (message) => {
                console.log('Game: ', message);
                sendFrameMessage(message);
            });
            document.getElementById('joingame').onclick = (event) => {
                socket.emit('action', { action: 'join', payload: { id: 1, displayname: 'joe' } });
            };

            document.getElementById('reload').onclick = (event) => {
                socket.emit('reload', 'now!');
            };

            attachToFrame();

            function attachToFrame() {
                window.addEventListener('message', recvFrameMessage, false);
            }

            function detachFromFrame() {
                window.removeEventListener('message', recvFrameMessage, false);
            }

            function sendFrameMessage(msg) {
                let iframe = document.getElementById('game-sandbox');
                if (iframe) iframe.contentWindow.postMessage(msg, '*');
            }

            function recvFrameMessage(evt) {
                let data = evt.data;
                socket.emit('action', data);
            }
            console.log('LOADED');
        </script>
    </body>
</html>
