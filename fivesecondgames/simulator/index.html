<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>The HTML5 Herald</title>
        <meta name="description" content="The HTML5 Herald" />
        <meta name="author" content="SitePoint" />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.socket.io/3.1.3/socket.io.min.js"
            integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #wrapper {
                display: flex;
                flex-wrap: wrap;
            }

            #wrapper .sidebar {
                flex-basis: 20rem;
                flex-grow: 1;
            }

            #wrapper .maincontent {
                flex-basis: 0;
                flex-grow: 999;
            }

            #wrapper,
            #game-sandbox {
                width: 100%;
                height: 100%;
                border: 0;
                border-spacing: 0;
            }
        </style>
        <div id="wrapper">
            <div class="sidebar">
                <form>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input
                            type="text"
                            class="form-control"
                            id="username"
                            aria-describedby="userHelp"
                            placeholder="Enter username"
                        />
                        <small id="userHelp" class="form-text text-muted">Enter a username to join the game</small>
                    </div>
                    <button id="joingame" type="button" class="btn btn-primary">Join Game</button>
                    <button id="reload" type="button" class="btn btn-primary">Reload</button>
                </form>
            </div>
            <div class="maincontent">
                <iframe id="game-sandbox" sandbox="allow-scripts" src="/iframe"> </iframe>
            </div>
        </div>

        <script>
            var socket = null;

            function connect(username, onjoin) {
                if (socket && !socket.disconnected) {
                    socket.disconnect();
                }

                socket = io('ws://localhost:3000', {
                    transports: ['websocket'],
                    upgrade: true,
                    query: 'username=' + username,
                });

                if (onjoin) socket.on('connect', onjoin);
                socket.on('game', (message) => {
                    console.log('Game: ', message);
                    sendFrameMessage(message);
                });
            }

            function updateUser(username) {
                if (!username || username.length == 0) return;
                window.sessionStorage.setItem('name', username);
                // window.sessionStorage.setItem(username, stringHashCode(username));
            }

            function getUsername() {
                return window.sessionStorage.getItem('name') || '';
            }

            let nameField = document.getElementById('username');
            nameField.value = getUsername();

            nameField.onkeyup = (event) => {
                let username = event.target.value;
                updateUser(username);
            };

            document.getElementById('joingame').onclick = (event) => {
                let displayname = getUsername();
                if (displayname.trim().length == 0) {
                    alert('Please enter a username.');
                    return;
                }

                connect(displayname, () => {
                    if (socket) socket.emit('action', { type: 'join', payload: {} });
                });
            };

            document.getElementById('reload').onclick = (event) => {
                if (socket) socket.emit('reload', 'now!');
            };

            attachToFrame();

            function attachToFrame() {
                window.addEventListener('message', recvFrameMessage, false);
            }

            function detachFromFrame() {
                window.removeEventListener('message', recvFrameMessage, false);
            }

            function sendFrameMessage(msg) {
                let iframe = document.getElementById('game-sandbox');

                if (iframe) iframe.contentWindow.postMessage(msg, '*');
            }

            function recvFrameMessage(evt) {
                let data = evt.data;
                if (socket) socket.emit('action', data);
            }
            console.log('LOADED');
        </script>
    </body>
</html>
