(()=>{"use strict";const e=new class{constructor(){this.msg=JSON.parse(JSON.stringify(globals.action())),this.originalGame=JSON.parse(JSON.stringify(globals.game())),this.nextGame=JSON.parse(JSON.stringify(globals.game())),this.isNewGame=!1,this.markedForDelete=!1,this.nextGame&&0!=Object.keys(this.nextGame.rules).length||(this.isNewGame=!0,this.error("Missing Rules")),this.nextGame&&("state"in this.nextGame||(this.nextGame.state={}),"players"in this.nextGame||(this.nextGame.players={}),this.nextGame.prev={},"next"in this.nextGame||(this.nextGame.next={}),"rules"in this.nextGame||(this.nextGame.rules={}),this.nextGame.events=[])}on(e,t){if(this.msg.type==e)t(this.msg);else if("newgame"==e&&this.isNewGame){let e=t(this.msg);this.nextGame=Object.assign({},e,{players:this.nextGame.players})}}submit(){globals.finish(this.nextGame)}killGame(){this.markedForDelete=!0,globals.killGame()}log(e){globals.log(e)}error(e){globals.error(e)}action(){return this.msg}state(e,t){return void 0===e?this.nextGame.state:void 0===t?this.nextGame.state[e]:void(this.nextGame.state[e]=t)}playerList(){return Object.keys(this.nextGame.players)}playerCount(){return Object.keys(this.nextGame.players).length}players(e,t){return void 0===e?this.nextGame.players:void 0===t?this.nextGame.players[e]:void(this.nextGame.players[e]=t)}rules(e,t){return void 0===e?this.nextGame.rules:void 0===t?this.nextGame.rules[e]:void(this.nextGame.rules[e]=t)}prev(e){return"object"==typeof e&&(this.nextGame.prev=e),this.nextGame.prev}next(e){return"object"==typeof e&&(this.nextGame.next=e),this.nextGame.next}event(e){this.nextGame.events.push(e)}clearEvents(){this.nextGame.events=[]}events(e){if(void 0===e)return this.nextGame.events;this.nextGame.events.push(e)}};let t={state:{cells:["","","","","","","","",""],startPlayer:""},players:{},rules:{bestOf:5,maxPlayers:2},next:{},events:[]};const s=new class{onNewGame(){return t}onJoin(){let t=e.action();if(!t.userid)return;if(e.players(t.userid).type)return;let s=e.rules("maxPlayers")||2;e.playerCount()>=s&&this.newRound()}onLeave(){let t=e.players(),s=e.action(),i=null;if(t[s.userid]&&(i=this.selectNextPlayer(s.userid),delete t[s.userid]),i){let e=t[i];this.setWinner(e.type,"forfeit")}}onPick(){let t=e.state(),s=e.action(),i=e.players(s.userid),r=s.payload.cell;if(t.cells[r].length>0)return void e.next({userid:s.userid,action:"pick",error:"NOT_EMPTY"});let n=i.type,a=s.userid;t.cells[r]=n,e.event("picked"),e.prev({cellid:r,userid:a}),this.checkWinner()||this.selectNextPlayer()}newRound(){let t=e.playerList();this.startPlayer&&0!=this.startPlayer.length?this.startPlayer=this.selectNextPlayer(this.startPlayer):this.startPlayer=this.selectNextPlayer(t[Math.floor(Math.random()*t.length)]);let s=e.players();for(var i in s)s[i].type="O";s[this.startPlayer].type="X"}selectNextPlayer(t){let s=e.action(),i=e.playerList();t=t||s.userid;let r=i.filter((e=>e!=s.userid));return e.next({userid:r[0],action:"pick"}),r[0]}checkWinner(){return!!(this.check([0,1,2])||this.check([3,4,5])||this.check([6,7,8])||this.check([0,3,6])||this.check([1,4,7])||this.check([2,5,8])||this.check([0,4,8])||this.check([6,4,2])||this.checkNoneEmpty())}checkNoneEmpty(){let t=e.state().cells.filter((e=>""==e));return 0==t.length&&this.setTie(),0==t.length}check(t){let s=e.state().cells,i=s[t[0]];if(""==i)return!1;let r=t.filter((e=>s[e]==i));return 3==r.length&&r.length==t.length&&(this.setWinner(i,t),!0)}findPlayerWithType(t){let s=e.players();for(var i in s)if(s[i].type==t)return i;return null}setTie(){e.clearEvents(),e.event("tie"),e.next({}),e.prev({}),e.killGame()}setWinner(t,s){let i=this.findPlayerWithType(t),r=e.players(i);r||(r.userid="unknown player"),e.clearEvents(),e.event("winner"),e.prev({pick:t,strip:s,userid:i}),e.next({})}};e.on("newgame",(()=>s.onNewGame())),e.on("join",(()=>s.onJoin())),e.on("leave",(()=>s.onLeave())),e.on("pick",(()=>s.onPick())),e.submit()})();